<!--         ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è       -->
<!-- mielon.eu/super_secret -->
<!--         ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è       -->





<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mielon</title>
    <link rel="icon" href="https://winterforest.mielon.eu/assets/favicon.png">
    <style>
        :root {
            --bg-dark: #1e1e2e;
            --bg-panel: #252535;
            --accent: #7aa2f7;
            --text: #c0caf5;
            --border: #414868;
            --hover: #3b4261;
            --header-height: 36px;
            --danger: #f7768e;
        }

        * { box-sizing: border-box; user-select: none; outline: none; }
        
        body {
            margin: 0; padding: 0;
            background-color: var(--bg-dark);
            color: var(--text);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        .toolbar {
            width: 64px;
            background-color: var(--bg-panel);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px 0;
            gap: 8px;
            z-index: 20;
            overflow-y: auto;
        }

        .top-bar {
            position: absolute;
            top: 0; left: 64px; right: 280px;
            height: var(--header-height);
            background-color: var(--bg-panel);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            padding: 0 10px;
            z-index: 15;
        }

        .workspace {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: #181825;
            background-image: radial-gradient(#2a2a3a 1px, transparent 1px);
            background-size: 20px 20px;
            margin-top: var(--header-height);
            position: relative;
        }

        .sidebar {
            width: 280px;
            background-color: var(--bg-panel);
            border-left: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            padding: 15px;
            gap: 20px;
            overflow-y: auto;
            z-index: 20;
        }

        .menu-item { position: relative; display: inline-block; }
        .menu-btn {
            background: none; border: none; color: var(--text);
            font-weight: bold; font-size: 13px; padding: 6px 12px;
            cursor: pointer; border-radius: 4px;
        }
        .menu-btn:hover { background-color: var(--hover); }
        
        .dropdown-content {
            display: none;
            position: absolute;
            top: 100%; left: 0;
            background-color: var(--bg-panel);
            min-width: 180px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.6);
            border: 1px solid var(--border);
            border-radius: 4px;
            z-index: 100;
        }
        .dropdown-content div {
            color: var(--text);
            padding: 10px 15px;
            text-decoration: none;
            display: block;
            cursor: pointer;
            font-size: 13px;
        }
        .dropdown-content div:hover { background-color: var(--hover); }
        .menu-item:hover .dropdown-content { display: block; }

        .canvas-wrapper {
            position: relative;
            width: 512px; height: 512px;
            box-shadow: 0 0 30px rgba(0,0,0,0.5);
            cursor: crosshair;
        }
        .canvas-wrapper.move-mode { cursor: move; }

        canvas#mainCanvas {
            width: 100%; height: 100%;
            image-rendering: pixelated;
            background-color: white;
            background-image: 
                linear-gradient(45deg, #ccc 25%, transparent 25%), 
                linear-gradient(-45deg, #ccc 25%, transparent 25%), 
                linear-gradient(45deg, transparent 75%, #ccc 75%), 
                linear-gradient(-45deg, transparent 75%, #ccc 75%);
            background-size: 20px 20px;
            background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
            display: block;
        }

        canvas.overlay-canvas {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none;
        }

        .tool-btn {
            width: 50px; height: 50px;
            border-radius: 6px; border: 1px solid var(--border);
            background: transparent; color: var(--text);
            cursor: pointer; 
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            transition: all 0.1s;
            gap: 2px;
        }
        .tool-icon { font-size: 18px; line-height: 1; }
        .tool-label { font-size: 9px; color: #888; text-transform: uppercase; }
        
        .tool-btn:hover { background-color: var(--hover); }
        .tool-btn.active { background-color: var(--accent); border-color: var(--accent); }
        .tool-btn.active .tool-icon, .tool-btn.active .tool-label { color: #1e1e2e; font-weight: bold; }

        .btn-mini {
            width: 100%; padding: 2px; font-size: 10px; 
            background: var(--bg-dark); border: 1px solid var(--border); 
            color: var(--danger); border-radius: 4px; cursor: pointer; margin-top: -4px;
        }
        .btn-mini:hover { background: var(--hover); }

        input[type="color"] {
            width: 40px; height: 40px; border: none; padding: 0; background: none; cursor: pointer;
        }

        .panel-title {
            font-size: 11px; text-transform: uppercase; letter-spacing: 1px;
            color: #888; margin-bottom: 8px; border-bottom: 1px solid var(--border);
            padding-bottom: 4px; display: flex; justify-content: space-between; align-items: center;
        }

        .layer-list {
            display: flex; flex-direction: column-reverse;
            gap: 4px; max-height: 220px; overflow-y: auto;
            padding: 6px; border: 1px solid #2a2a35; border-radius: 4px; background: #1a1a25;
        }
        .layer-item {
            display: flex; align-items: center;
            background: var(--bg-panel); padding: 0 8px;
            height: 36px;
            border-radius: 4px; border: 1px solid var(--border);
        }
        .layer-item.active { border-color: var(--accent); background: #2f354b; }
        
        .layer-name-input {
            flex: 1; margin-left: 8px;
            background: transparent; border: 1px solid transparent;
            color: var(--text); font-size: 12px; padding: 4px;
            border-radius: 2px;
            height: 24px;
        }
        .layer-name-input:focus { background: var(--bg-dark); border-color: var(--accent); }
        .layer-vis { cursor: pointer; font-size: 14px; width: 24px; display: flex; justify-content: center; }
        .layer-vis.hidden { opacity: 0.3; }

        .btn-small {
            background: var(--bg-dark); border: 1px solid var(--border);
            color: var(--text); padding: 4px 8px; border-radius: 4px;
            cursor: pointer; font-size: 11px; flex: 1;
        }
        .btn-small:hover { background: var(--hover); }

        .preview-wrapper {
            width: 100%; aspect-ratio: 1;
            position: relative; border: 1px solid var(--border);
            background: #000;
        }
        canvas#previewCanvas { width: 100%; height: 100%; display: block; image-rendering: pixelated; }
        
        canvas#previewGrid {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none;
            mix-blend-mode: difference;
            opacity: 0;
            image-rendering: pixelated;
        }
        canvas#previewGrid.visible { opacity: 1; }

        .checkbox-wrapper { display: flex; align-items: center; gap: 8px; font-size: 12px; margin-top: 6px; color: #aaa; }

        .modal-backdrop {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7); z-index: 500;
            display: none; justify-content: center; align-items: center;
        }
        .modal-backdrop.open { display: flex; }
        .modal-content {
            background: var(--bg-panel); border: 1px solid var(--border);
            padding: 20px; border-radius: 6px; width: 300px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.8);
        }
        .modal-header { font-weight: bold; margin-bottom: 15px; font-size: 14px; border-bottom: 1px solid var(--border); padding-bottom: 10px;}
        
        input[type="text"], select {
            width: 100%; padding: 8px; margin-bottom: 10px;
            border-radius: 4px; border: 1px solid var(--border);
            background: var(--bg-dark); color: var(--text); font-size: 13px;
        }
        .modal-actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 10px; }

        .float-window {
            position: fixed; top: 100px; left: 100px; width: 260px;
            background: var(--bg-panel); border: 1px solid var(--border);
            box-shadow: 0 10px 30px rgba(0,0,0,0.5); border-radius: 6px;
            display: none; flex-direction: column; z-index: 1000;
        }
        .float-window.visible { display: flex; }
        .fw-header {
            background: var(--hover); padding: 8px 10px; cursor: move;
            font-size: 12px; font-weight: bold; border-top-left-radius: 6px; border-top-right-radius: 6px;
            display: flex; justify-content: space-between;
        }
        .fw-body { padding: 15px; }
        .slider-container { margin-bottom: 12px; }
        .slider-label { display: flex; justify-content: space-between; font-size: 11px; margin-bottom: 4px; color: #aaa; }
        input[type=range] { width: 100%; cursor: pointer; }

    </style>
</head>
<body>

    <div class="toolbar">
        <input type="color" id="colorPicker" value="#000000" title="Color">
        
        <div class="tool-btn active" onclick="setTool('pen')">
            <span class="tool-icon">‚úèÔ∏è</span><span class="tool-label">Pencil</span>
        </div>
        <div class="tool-btn" onclick="setTool('eraser')">
            <span class="tool-icon">üßΩ</span><span class="tool-label">Eraser</span>
        </div>
        <div class="tool-btn" onclick="setTool('bucket')">
            <span class="tool-icon">ü™£</span><span class="tool-label">Bucket</span>
        </div>
        
        <div style="display:flex; flex-direction:column; align-items:center; gap:2px;">
            <div class="tool-btn" onclick="setTool('select')">
                <span class="tool-icon">‚õù</span><span class="tool-label">Select</span>
            </div>
            <button class="btn-mini" style="width: 50px;" onclick="clearSelection()" title="Clear Selection">Deselect</button>
        </div>

        <div class="tool-btn" onclick="setTool('move')">
            <span class="tool-icon">‚ú•</span><span class="tool-label">Move</span>
        </div>

        <div class="tool-btn" onclick="setTool('picker')">
            <span class="tool-icon">üíâ</span><span class="tool-label">Picker</span>
        </div>

        <div style="height: 1px; background: var(--border); width: 80%; margin: 5px 0;"></div>
        
        <div class="tool-btn" onclick="undo()" style="height: 40px;">
            <span class="tool-icon">‚Ü©Ô∏è</span>
        </div>
        <div class="tool-btn" onclick="redo()" style="height: 40px;">
            <span class="tool-icon">‚Ü™Ô∏è</span>
        </div>
    </div>

    <div class="top-bar">
        <div class="menu-item">
            <button class="menu-btn">File ‚ñæ</button>
            <div class="dropdown-content">
                <div onclick="triggerLoadProject()">üìÇ Open Project</div>
                <div onclick="openSaveDialog()">üíæ Save Project</div>
                <div onclick="triggerImportPNG()">üñºÔ∏è Import PNG</div>
                <div onclick="openExportDialog()">üì§ Export PNG</div>
            </div>
        </div>
    </div>

    <div class="workspace">
        <div class="canvas-wrapper" id="canvasWrapper">
            <canvas id="mainCanvas" width="16" height="16"></canvas>
            <canvas id="editorOverlay" class="overlay-canvas" width="512" height="512"></canvas>
        </div>
    </div>

    <div class="sidebar">
        <div>
            <div class="panel-title">Tool Settings</div>
            <div class="slider-container" style="margin-bottom: 0;">
                <div class="slider-label"><span>Tool Opacity</span><span id="toolAlphaVal">100%</span></div>
                <input type="range" min="0" max="100" value="100" id="toolAlphaInput" oninput="updateToolAlpha()">
            </div>
        </div>

        <div>
            <div class="panel-title">Tiling Preview</div>
            <div class="preview-wrapper">
                <canvas id="previewCanvas" width="48" height="48"></canvas>
                <canvas id="previewGrid" width="48" height="48"></canvas>
            </div>
            <div class="checkbox-wrapper">
                <input type="checkbox" id="gridCheck" onchange="updatePreview()">
                <label for="gridCheck">Show Grid (Preview)</label>
            </div>
            <div class="checkbox-wrapper">
                <input type="checkbox" id="mainGridCheck" onchange="requestRender()">
                <label for="mainGridCheck">Pixel Grid (Editor)</label>
            </div>
        </div>

        <div>
            <div class="panel-title">
                Layers
                <button class="btn-small" style="flex:0; width: auto;" onclick="openFilters()">üé® Adjust</button>
            </div>
            <div class="slider-container" style="margin: 8px 0;">
                <div class="slider-label"><span>Layer Opacity</span><span id="layerOpacityVal">100%</span></div>
                <input type="range" min="0" max="100" value="100" id="layerOpacityInput" oninput="updateLayerOpacity()">
            </div>
            <div style="display:flex; gap:2px; margin-bottom:5px;">
                <button class="btn-small" onclick="addLayer()">+ Add</button>
                <button class="btn-small" onclick="deleteLayer()">- Remove</button>
                <button class="btn-small" onclick="moveLayer(1)">‚¨Ü</button>
                <button class="btn-small" onclick="moveLayer(-1)">‚¨á</button>
            </div>
            <div class="layer-list" id="layerList"></div>
        </div>
    </div>

    <input type="file" id="fileInputProject" accept=".mielonaipaint" style="display:none" onchange="loadProject(this)">
    <input type="file" id="fileInputPNG" accept="image/png" style="display:none" onchange="importPNG(this)">

    <div id="saveModal" class="modal-backdrop">
        <div class="modal-content">
            <div class="modal-header">Save Project</div>
            <label style="font-size:12px;">Filename:</label>
            <input type="text" id="saveFilename" value="my_project">
            <div class="modal-actions">
                <button class="btn-small" onclick="closeModal('saveModal')">Cancel</button>
                <button class="btn-small" style="background:var(--accent); color:#1e1e2e; font-weight:bold;" onclick="confirmSaveProject()">Save</button>
            </div>
        </div>
    </div>

    <div id="exportModal" class="modal-backdrop">
        <div class="modal-content">
            <div class="modal-header">Export PNG</div>
            <label style="font-size:12px;">Filename:</label>
            <input type="text" id="exportFilename" value="texture">
            <label style="font-size:12px;">Resolution:</label>
            <select id="exportSize">
                <option value="1">16x16 (x1)</option>
                <option value="2">32x32 (x2)</option>
                <option value="4">64x64 (x4)</option>
                <option value="8">128x128 (x8)</option>
                <option value="16">256x256 (x16)</option>
                <option value="32" selected>512x512 (x32)</option>
            </select>
            <div class="modal-actions">
                <button class="btn-small" onclick="closeModal('exportModal')">Cancel</button>
                <button class="btn-small" style="background:var(--accent); color:#1e1e2e; font-weight:bold;" onclick="confirmExportPNG()">Download</button>
            </div>
        </div>
    </div>

    <div id="filterWindow" class="float-window">
        <div class="fw-header" id="fwHeader">
            <span>Color Adjustments</span>
            <span style="cursor:pointer;" onclick="closeFilters(false)">‚úï</span>
        </div>
        <div class="fw-body">
            <div class="slider-container"><div class="slider-label"><span>Brightness</span><span id="valBri">0</span></div><input type="range" min="-100" max="100" value="0" id="slBri" oninput="previewFilters()"></div>
            <div class="slider-container"><div class="slider-label"><span>Contrast</span><span id="valCon">0</span></div><input type="range" min="-100" max="100" value="0" id="slCon" oninput="previewFilters()"></div>
            <div class="slider-container"><div class="slider-label"><span>Saturation</span><span id="valSat">0</span></div><input type="range" min="-100" max="100" value="0" id="slSat" oninput="previewFilters()"></div>
            <div class="slider-container"><div class="slider-label"><span>Hue</span><span id="valHue">0</span></div><input type="range" min="-180" max="180" value="0" id="slHue" oninput="previewFilters()"></div>
        </div>
        <div style="padding:10px; display:flex; gap:5px; justify-content:flex-end;">
            <button class="btn-small" onclick="closeFilters(false)">Cancel</button>
            <button class="btn-small" style="background:var(--accent); color:#1e1e2e;" onclick="closeFilters(true)">Apply</button>
        </div>
    </div>

    <script>
        const SIZE = 16;
        const SCALE = 32;
        const MAX_HISTORY = 50;

        let layers = [];
        let activeLayerId = 0;
        let layerCounter = 0;
        let currentTool = 'pen';
        let isDrawing = false;
        let color = '#000000';
        let history = [];
        let historyIndex = -1;
        let isHistoryLocked = false;
        let toolAlpha = 255;

        let isSelecting = false;
        let selection = null;
        let selectionStart = null; 
        let clipboard = null; 
        
        let isMoving = false;
        let moveStartCoords = null;
        let moveOffset = {x:0, y:0};
        let moveBuffer = null;

        let filterOriginalData = null;

        const mainCanvas = document.getElementById('mainCanvas');
        const mainCtx = mainCanvas.getContext('2d');
        const overlayCanvas = document.getElementById('editorOverlay');
        const overlayCtx = overlayCanvas.getContext('2d');
        const previewCanvas = document.getElementById('previewCanvas');
        const previewCtx = previewCanvas.getContext('2d');
        const previewGridCanvas = document.getElementById('previewGrid');
        const previewGridCtx = previewGridCanvas.getContext('2d');
        const layerListEl = document.getElementById('layerList');
        const colorInput = document.getElementById('colorPicker');
        const gridCheck = document.getElementById('gridCheck');
        const mainGridCheck = document.getElementById('mainGridCheck');
        const toolAlphaInput = document.getElementById('toolAlphaInput');
        const layerOpacityInput = document.getElementById('layerOpacityInput');

        function init() {
            addLayer('Background', false);
            saveHistory();

            const wrapper = document.getElementById('canvasWrapper');
            wrapper.addEventListener('mousedown', handleMouseDown);
            window.addEventListener('mousemove', handleMouseMove);
            window.addEventListener('mouseup', handleMouseUp);
            
            colorInput.addEventListener('change', (e) => color = e.target.value);
            document.addEventListener('keydown', handleKeyDown);
            makeDraggable(document.getElementById('fwHeader'), document.getElementById('filterWindow'));

            render();
            drawGridOverlay();
        }

        function updateToolAlpha() {
            const val = parseInt(toolAlphaInput.value);
            toolAlpha = Math.floor((val / 100) * 255);
            document.getElementById('toolAlphaVal').innerText = val + '%';
        }

        function updateLayerOpacity() {
            const l = getActiveLayer();
            if(!l) return;
            l.opacity = parseInt(layerOpacityInput.value) / 100;
            document.getElementById('layerOpacityVal').innerText = layerOpacityInput.value + '%';
            render();
        }

        function syncLayerOpacityUI() {
            const l = getActiveLayer();
            if(l) {
                const val = Math.round(l.opacity * 100);
                layerOpacityInput.value = val;
                document.getElementById('layerOpacityVal').innerText = val + '%';
            }
        }

        function getCoords(e) {
            const rect = mainCanvas.getBoundingClientRect();
            const x = Math.floor((e.clientX - rect.left) / SCALE);
            const y = Math.floor((e.clientY - rect.top) / SCALE);
            return { x, y };
        }

        function handleMouseDown(e) {
            if(e.button !== 0) return;
            const coords = getCoords(e);
            
            if(currentTool === 'move') {
                startMove(coords.x, coords.y);
            } else if(currentTool === 'select') {
                isSelecting = true;
                selectionStart = coords;
                selection = {x: coords.x, y: coords.y, w: 1, h: 1};
                renderOverlay();
            } else {
                if(selection && currentTool !== 'picker') { selection = null; renderOverlay(); }
                
                if(coords.x >= 0 && coords.x < SIZE && coords.y >= 0 && coords.y < SIZE) {
                    isDrawing = true;
                    useTool(coords.x, coords.y, true);
                }
            }
        }

        function handleMouseMove(e) {
            const coords = getCoords(e);
            
            if(isMoving) {
                updateMove(coords.x, coords.y);
            } else if(isSelecting) {
                const minX = Math.max(0, Math.min(coords.x, selectionStart.x));
                const minY = Math.max(0, Math.min(coords.y, selectionStart.y));
                const maxX = Math.min(SIZE-1, Math.max(coords.x, selectionStart.x));
                const maxY = Math.min(SIZE-1, Math.max(coords.y, selectionStart.y));
                selection = { x: minX, y: minY, w: maxX - minX + 1, h: maxY - minY + 1 };
                renderOverlay();
            } else if(isDrawing) {
                if(coords.x >= 0 && coords.x < SIZE && coords.y >= 0 && coords.y < SIZE) 
                    useTool(coords.x, coords.y, false);
            }
        }

        function handleMouseUp() {
            if(isMoving) endMove();
            if(isSelecting) isSelecting = false;
            if(isDrawing) { isDrawing = false; saveHistory(); }
        }

        function handleKeyDown(e) {
            if(e.target.tagName === 'INPUT') return;
            if(e.ctrlKey && e.key === 'z') { e.preventDefault(); undo(); }
            if(e.ctrlKey && (e.key === 'y' || (e.shiftKey && e.key === 'Z'))) { e.preventDefault(); redo(); }
            if(e.ctrlKey && e.key === 'c') { e.preventDefault(); copySelection(); }
            if(e.ctrlKey && e.key === 'v') { e.preventDefault(); pasteSelection(); }

            const k = e.key.toLowerCase();
            if(k === 'p') setTool('pen');
            if(k === 'e') setTool('eraser');
            if(k === 'b') setTool('bucket');
            if(k === 'i') setTool('picker');
            if(k === 'm') setTool('select');
            if(k === 'v') setTool('move');
        }

        function setTool(t) {
            currentTool = t;
            document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active'));
            const map = {'pen':0, 'eraser':1, 'bucket':2, 'select':3, 'move':4, 'picker':5};
            if(map[t] !== undefined) document.querySelectorAll('.tool-btn')[map[t]].classList.add('active');
            
            const cw = document.getElementById('canvasWrapper');
            cw.className = 'canvas-wrapper ' + (t === 'move' ? 'move-mode' : (t === 'select' ? 'select-mode' : ''));
        }

        function clearSelection() {
            selection = null;
            renderOverlay();
        }

        function useTool(x, y, isClick) {
            const l = getActiveLayer();
            if(!l || !l.visible) return;

            if(currentTool === 'pen') {
                const r = parseInt(color.slice(1, 3), 16);
                const g = parseInt(color.slice(3, 5), 16);
                const b = parseInt(color.slice(5, 7), 16);
                l.ctx.fillStyle = `rgba(${r},${g},${b},${toolAlpha/255})`;
                l.ctx.clearRect(x, y, 1, 1);
                l.ctx.fillRect(x, y, 1, 1);
            } else if(currentTool === 'eraser') {
                l.ctx.clearRect(x, y, 1, 1);
            } else if(currentTool === 'picker') {
                pickColor(x, y); isDrawing = false; return;
            } else if(currentTool === 'bucket' && isClick) {
                floodFill(l.ctx, x, y, color);
                isDrawing = false; saveHistory();
            }
            render();
        }

        function startMove(x, y) {
            const l = getActiveLayer();
            if(!l) return;
            isMoving = true;
            moveStartCoords = {x, y};
            moveOffset = {x:0, y:0};

            moveBuffer = document.createElement('canvas');
            moveBuffer.width = SIZE; moveBuffer.height = SIZE;
            const bCtx = moveBuffer.getContext('2d');

            if(selection) {
                const data = l.ctx.getImageData(selection.x, selection.y, selection.w, selection.h);
                const tempC = document.createElement('canvas');
                tempC.width = selection.w; tempC.height = selection.h;
                tempC.getContext('2d').putImageData(data, 0, 0);
                
                bCtx.drawImage(tempC, selection.x, selection.y);
                
                l.ctx.clearRect(selection.x, selection.y, selection.w, selection.h);
            } else {
                bCtx.drawImage(l.canvas, 0, 0);
                l.ctx.clearRect(0, 0, SIZE, SIZE);
            }
            render();
        }

        function updateMove(x, y) {
            moveOffset.x = x - moveStartCoords.x;
            moveOffset.y = y - moveStartCoords.y;
            render();
        }

        function endMove() {
            isMoving = false;
            const l = getActiveLayer();
            if(l && moveBuffer) {
                l.ctx.drawImage(moveBuffer, moveOffset.x, moveOffset.y);
                
                if(selection) {
                    selection.x += moveOffset.x;
                    selection.y += moveOffset.y;
                }
                moveBuffer = null;
                saveHistory();
            }
            renderOverlay();
            render();
        }

        function copySelection() {
            if(!selection) return;
            const l = getActiveLayer();
            clipboard = l.ctx.getImageData(selection.x, selection.y, selection.w, selection.h);
        }

        function pasteSelection() {
            if(!clipboard) return;
            
            addLayer('Pasted', false);
            const l = getActiveLayer();
            
            const px = selection ? selection.x : 0;
            const py = selection ? selection.y : 0;

            const t = document.createElement('canvas');
            t.width = clipboard.width; t.height = clipboard.height;
            t.getContext('2d').putImageData(clipboard, 0, 0);
            
            l.ctx.drawImage(t, px, py);
            render();
            saveHistory();
        }

        class Layer {
            constructor(name, id=null) {
                this.id = id !== null ? id : layerCounter++;
                this.name = name || `Layer ${this.id}`;
                this.canvas = document.createElement('canvas');
                this.canvas.width = SIZE; this.canvas.height = SIZE;
                this.ctx = this.canvas.getContext('2d');
                this.visible = true;
                this.opacity = 1.0;
            }
        }

        function saveHistory() {
            if(isHistoryLocked) return;
            if(historyIndex < history.length - 1) history = history.slice(0, historyIndex + 1);
            const state = layers.map(l => ({ id: l.id, name: l.name, visible: l.visible, opacity: l.opacity, data: l.canvas.toDataURL() }));
            history.push({ activeId: activeLayerId, layers: state });
            if(history.length > MAX_HISTORY) history.shift();
            else historyIndex++;
        }

        function loadHistoryState(state) {
            isHistoryLocked = true;
            layers = [];
            const promises = state.layers.map(d => new Promise(r => {
                const l = new Layer(d.name, d.id);
                l.visible = d.visible;
                l.opacity = d.opacity !== undefined ? d.opacity : 1.0;
                const img = new Image();
                img.onload = () => { l.ctx.clearRect(0,0,SIZE,SIZE); l.ctx.drawImage(img,0,0); r(l); };
                img.src = d.data;
            }));
            Promise.all(promises).then(res => {
                layers = res;
                activeLayerId = state.activeId;
                layerCounter = layers.reduce((m,l)=>Math.max(m,l.id),0)+1;
                renderLayerList(); 
                syncLayerOpacityUI();
                render();
                isHistoryLocked = false;
            });
        }
        function undo() { if(historyIndex > 0) { historyIndex--; loadHistoryState(history[historyIndex]); } }
        function redo() { if(historyIndex < history.length - 1) { historyIndex++; loadHistoryState(history[historyIndex]); } }

        function addLayer(n, s=true) { 
            const l = new Layer(n); layers.push(l); activeLayerId=l.id; 
            renderLayerList(); syncLayerOpacityUI(); render(); if(s) saveHistory(); 
        }
        function deleteLayer() {
            if(layers.length<=1) return alert("No layers to delete");
            const idx = layers.findIndex(l=>l.id===activeLayerId);
            layers.splice(idx,1);
            activeLayerId=layers[Math.max(0,idx-1)].id;
            renderLayerList(); syncLayerOpacityUI(); render(); saveHistory();
        }
        function moveLayer(d) {
            const idx = layers.findIndex(l=>l.id===activeLayerId);
            if((d===1 && idx<layers.length-1) || (d===-1 && idx>0)) {
                [layers[idx], layers[idx+d]] = [layers[idx+d], layers[idx]];
                renderLayerList(); render(); saveHistory();
            }
        }
        function getActiveLayer() { return layers.find(l=>l.id===activeLayerId); }

        function renderLayerList() {
            layerListEl.innerHTML = '';
            layers.forEach(l => {
                const div = document.createElement('div');
                div.className = `layer-item ${l.id === activeLayerId ? 'active' : ''}`;
                div.onclick = (e) => { 
                    if(e.target.tagName !== 'INPUT' && !e.target.classList.contains('layer-vis')) { 
                        activeLayerId = l.id; renderLayerList(); syncLayerOpacityUI();
                    } 
                };

                const vis = document.createElement('div');
                vis.className = `layer-vis ${l.visible?'':'hidden'}`;
                vis.innerText = 'üëÅÔ∏è';
                vis.onclick = (e) => { e.stopPropagation(); l.visible=!l.visible; render(); renderLayerList(); };

                const inp = document.createElement('input');
                inp.type = 'text';
                inp.className = 'layer-name-input';
                inp.value = l.name;
                inp.onchange = () => { l.name = inp.value; }; 
                inp.onclick = (e) => e.stopPropagation();

                div.appendChild(vis);
                div.appendChild(inp);
                layerListEl.appendChild(div);
            });
        }

        function render() {
            mainCtx.clearRect(0,0,SIZE,SIZE);
            layers.forEach(l => { 
                if(l.visible) {
                    mainCtx.globalAlpha = l.opacity;
                    mainCtx.drawImage(l.canvas,0,0);
                    mainCtx.globalAlpha = 1.0;
                }
            });
            
            if(isMoving && moveBuffer) {
                mainCtx.drawImage(moveBuffer, moveOffset.x, moveOffset.y);
            }

            updatePreview();
        }

        function renderOverlay() {
            overlayCtx.clearRect(0,0,512,512);
            
            if(mainGridCheck.checked) {
                overlayCtx.beginPath();
                overlayCtx.strokeStyle = 'rgba(255,255,255,0.05)';
                overlayCtx.lineWidth = 1;
                for(let i=1; i<SIZE; i++) {
                    overlayCtx.moveTo(i*SCALE, 0); overlayCtx.lineTo(i*SCALE, 512);
                    overlayCtx.moveTo(0, i*SCALE); overlayCtx.lineTo(512, i*SCALE);
                }
                overlayCtx.stroke();
            }

            if(selection) {
                overlayCtx.save();
                overlayCtx.strokeStyle = '#fff';
                overlayCtx.lineWidth = 2;
                overlayCtx.setLineDash([6, 6]);
                const dx = isMoving ? moveOffset.x : 0;
                const dy = isMoving ? moveOffset.y : 0;
                
                overlayCtx.strokeRect((selection.x+dx)*SCALE, (selection.y+dy)*SCALE, selection.w*SCALE, selection.h*SCALE);
                overlayCtx.strokeStyle = '#000';
                overlayCtx.lineDashOffset = 6;
                overlayCtx.strokeRect((selection.x+dx)*SCALE, (selection.y+dy)*SCALE, selection.w*SCALE, selection.h*SCALE);
                overlayCtx.restore();
            }
        }

        function requestRender() { renderOverlay(); }

        function updatePreview() {
            previewCtx.clearRect(0,0,48,48);
            for(let y=0; y<3; y++) {
                for(let x=0; x<3; x++) {
                    previewCtx.drawImage(mainCanvas, x*SIZE, y*SIZE);
                }
            }
            drawGridOverlay();
        }

        function drawGridOverlay() {
            previewGridCtx.clearRect(0,0,48,48);
            if(gridCheck.checked) {
                previewGridCtx.beginPath();
                previewGridCtx.strokeStyle = 'white';
                previewGridCtx.lineWidth = 1; 
                
                previewGridCtx.moveTo(16.5, 0); previewGridCtx.lineTo(16.5, 48);
                previewGridCtx.moveTo(32.5, 0); previewGridCtx.lineTo(32.5, 48);
                previewGridCtx.moveTo(0, 16.5); previewGridCtx.lineTo(48, 16.5);
                previewGridCtx.moveTo(0, 32.5); previewGridCtx.lineTo(48, 32.5);
                previewGridCtx.stroke();
                
                previewGridCanvas.classList.add('visible');
            } else {
                previewGridCanvas.classList.remove('visible');
            }
        }

        function pickColor(x, y) {
            const d = mainCtx.getImageData(x,y,1,1).data;
            if(d[3]===0) return;
            color = "#" + ((1<<24)+(d[0]<<16)+(d[1]<<8)+d[2]).toString(16).slice(1);
            colorInput.value = color;
            setTool('pen');
        }

        function floodFill(ctx, x, y, hex) {
            const d = ctx.getImageData(0,0,SIZE,SIZE);
            const data = d.data;
            const r=parseInt(hex.slice(1,3),16), g=parseInt(hex.slice(3,5),16), b=parseInt(hex.slice(5,7),16);
            const idx = (y*SIZE+x)*4;
            const tr=data[idx], tg=data[idx+1], tb=data[idx+2], ta=data[idx+3];
            
            if(tr===r && tg===g && tb===b && ta===toolAlpha) return;
            
            const stack = [[x,y]];
            while(stack.length) {
                const [cx,cy] = stack.pop();
                if(cx<0||cx>=SIZE||cy<0||cy>=SIZE) continue;
                const i = (cy*SIZE+cx)*4;
                if(data[i]===tr && data[i+1]===tg && data[i+2]===tb && data[i+3]===ta) {
                    data[i]=r; data[i+1]=g; data[i+2]=b; data[i+3]=toolAlpha;
                    stack.push([cx+1,cy],[cx-1,cy],[cx,cy+1],[cx,cy-1]);
                }
            }
            ctx.putImageData(d,0,0);
        }

        function closeModal(id) { document.getElementById(id).classList.remove('open'); }
        function openSaveDialog() { document.getElementById('saveModal').classList.add('open'); }
        function openExportDialog() { document.getElementById('exportModal').classList.add('open'); }

        function confirmSaveProject() {
            const name = document.getElementById('saveFilename').value || 'my_project';
            const data = {
                size: SIZE, activeId: activeLayerId,
                layers: layers.map(l => ({ id: l.id, name: l.name, visible: l.visible, opacity: l.opacity, data: l.canvas.toDataURL() }))
            };
            const b = new Blob([JSON.stringify(data)], {type: 'text/plain'});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(b); a.download = name + '.mielonaipaint'; a.click();
            closeModal('saveModal');
        }

        function confirmExportPNG() {
            const scale = parseInt(document.getElementById('exportSize').value);
            const name = document.getElementById('exportFilename').value || 'texture';
            const final = SIZE * scale;
            const tc = document.createElement('canvas'); tc.width=final; tc.height=final;
            const ctx = tc.getContext('2d');
            ctx.imageSmoothingEnabled = false;
            ctx.drawImage(mainCanvas, 0, 0, final, final);
            const link = document.createElement('a');
            link.download = `${name}_${final}x${final}.png`;
            link.href = tc.toDataURL('image/png');
            link.click();
            closeModal('exportModal');
        }

        function triggerLoadProject() { document.getElementById('fileInputProject').click(); }
        function loadProject(inp) {
            const f = inp.files[0]; if(!f) return;
            const r = new FileReader();
            r.onload = (e) => {
                try {
                    const p = JSON.parse(e.target.result);
                    history=[]; historyIndex=-1;
                    loadHistoryState({activeId: p.activeId, layers: p.layers});
                    setTimeout(()=>{history=[];saveHistory();},200);
                } catch(err){alert("File Error");}
            };
            r.readAsText(f); inp.value='';
        }
        function triggerImportPNG() { document.getElementById('fileInputPNG').click(); }
        function importPNG(inp) {
            const f = inp.files[0]; if(!f) return;
            const r = new FileReader();
            r.onload = (e) => {
                const i = new Image();
                i.onload = () => {
                    if(i.width!==16 || i.height!==16) return alert("16x16 px required");
                    addLayer(f.name.replace('.png',''), false);
                    getActiveLayer().ctx.drawImage(i,0,0);
                    render(); saveHistory();
                };
                i.src = e.target.result;
            };
            r.readAsDataURL(f); inp.value='';
        }

        function openFilters() {
            const l=getActiveLayer(); if(!l)return;
            filterOriginalData = l.ctx.getImageData(0,0,SIZE,SIZE);
            ['Bri','Con','Sat','Hue'].forEach(k=>document.getElementById('sl'+k).value=0);
            previewFilters();
            document.getElementById('filterWindow').classList.add('visible');
        }
        function closeFilters(save) {
            document.getElementById('filterWindow').classList.remove('visible');
            if(save) saveHistory();
            else { getActiveLayer().ctx.putImageData(filterOriginalData,0,0); render(); }
        }
        function previewFilters() {
            if(!filterOriginalData) return;
            const bri=parseInt(document.getElementById('slBri').value);
            const con=parseInt(document.getElementById('slCon').value);
            const sat=parseInt(document.getElementById('slSat').value);
            const hue=parseInt(document.getElementById('slHue').value);
            
            ['Bri','Con','Sat','Hue'].forEach(k=>document.getElementById('val'+k).innerText = document.getElementById('sl'+k).value);

            const d = new Uint8ClampedArray(filterOriginalData.data);
            for(let i=0; i<d.length; i+=4) {
                if(d[i+3]===0) continue;
                let r=d[i], g=d[i+1], b=d[i+2];
                
                if(con!==0) {
                    const f = (259*(con+255))/(255*(259-con));
                    r = f*(r-128)+128; g = f*(g-128)+128; b = f*(b-128)+128;
                }
                r+=bri; g+=bri; b+=bri;

                r/=255; g/=255; b/=255;
                const max=Math.max(r,g,b), min=Math.min(r,g,b);
                let h, s, l=(max+min)/2;
                if(max!==min) {
                    const df=max-min;
                    s = l>0.5 ? df/(2-max-min) : df/(max+min);
                    if(max===r) h=(g-b)/df + (g<b?6:0);
                    else if(max===g) h=(b-r)/df + 2;
                    else h=(r-g)/df + 4;
                    h/=6;
                } else { h=s=0; }

                h = (h*360 + hue) % 360; if(h<0)h+=360;
                s = Math.min(1, Math.max(0, s + sat/100));

                const q=l<0.5 ? l*(1+s) : l+s-l*s;
                const p=2*l-q;
                const h2r = (t) => {
                    if(t<0)t+=1;if(t>1)t-=1;
                    if(t<1/6) return p+(q-p)*6*t;
                    if(t<1/2) return q;
                    if(t<2/3) return p+(q-p)*(2/3-t)*6;
                    return p;
                };
                r=h2r(h/360+1/3); g=h2r(h/360); b=h2r(h/360-1/3);
                d[i]=r*255; d[i+1]=g*255; d[i+2]=b*255;
            }
            getActiveLayer().ctx.putImageData(new ImageData(d,SIZE,SIZE),0,0);
            render();
        }

        function makeDraggable(handle, el) {
            let isDown=false, sx, sy, l, t;
            handle.addEventListener('mousedown',e=>{isDown=true;sx=e.clientX;sy=e.clientY;l=el.offsetLeft;t=el.offsetTop;handle.style.cursor='grabbing';});
            window.addEventListener('mousemove',e=>{if(!isDown)return;el.style.left=(l+e.clientX-sx)+'px';el.style.top=(t+e.clientY-sy)+'px';});
            window.addEventListener('mouseup',()=>{isDown=false;handle.style.cursor='move';});
        }

        init();
    </script>
</body>
</html>
